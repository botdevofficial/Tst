<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OTP Login (Telegram)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#131a2b; --muted:#9fb0ff; --text:#eaf0ff; --accent:#6ea8fe; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; color:var(--text); display:grid; place-items:center; min-height:100vh; }
    .card { width:min(440px, 92vw); background:var(--card); border:1px solid #223058; border-radius:20px; padding:22px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:1.25rem; }
    p.note { margin:.25rem 0 1rem; color:var(--muted); font-size:.95rem; }
    label { display:block; margin:.6rem 0 .25rem; font-weight:600; }
    input { width:100%; padding:12px 14px; background:#0e1426; border:1px solid #2a3a66; color:var(--text); border-radius:12px; outline:none; }
    input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(110,168,254,.25); }
    .row { display:flex; gap:10px; }
    button { width:100%; margin-top:14px; padding:12px 16px; border-radius:12px; border:0; font-weight:700; background:var(--accent); color:#06102a; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:.9rem; }
    .center { text-align:center; }
    .hidden { display:none; }
    .danger { color:#ff9aa2; }
    .success { color:#a2f5b5; }
    .hr { height:1px; background:#25335e; margin:16px 0; }
    .top-actions { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    kbd { background:#0f1731; border:1px solid #2a3a66; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="top-actions">
      <h1>OTP Login</h1>
      <button id="resetBtn" style="width:auto; padding:8px 10px; margin:0;" title="Clear saved session">Reset</button>
    </div>
    <p class="note">Enter your Email, Password, and Telegram User ID. We’ll send an OTP via our Telegram bot.</p>

    <!-- Step 1: Credentials -->
    <form id="formStart">
      <label>Email</label>
      <input type="email" id="email" placeholder="you@example.com" required />

      <label>Password</label>
      <input type="password" id="password" placeholder="••••••••" required />

      <label>Telegram User ID</label>
      <input type="text" id="tgid" placeholder="e.g., 123456789" required />

      <button type="submit" id="btnSend">Send OTP</button>
      <p class="muted center">Make sure you can receive messages from bots in Telegram.</p>
    </form>

    <!-- Step 2: OTP -->
    <form id="formOtp" class="hidden">
      <div class="center">
        <p class="muted">We sent an OTP to your Telegram ID <span id="tgidShow"></span>.</p>
        <p class="muted">Session: <kbd id="sessShow"></kbd> • Expires: <span id="expShow" class="muted"></span></p>
      </div>
      <label>Enter OTP</label>
      <input type="text" id="otp" inputmode="numeric" maxlength="8" placeholder="6-digit code" required />
      <button type="submit" id="btnVerify">Verify OTP</button>
      <div class="hr"></div>
      <div class="center">
        <button type="button" id="btnResend" style="width:auto;">Resend OTP</button>
      </div>
    </form>

    <div id="msg" class="center muted" style="margin-top:10px;"></div>
  </div>

  <script>
    // ======== CONFIG ========
    // IMPORTANT: This frontend API key must match the backend API key (env: API_KEY)
    const FRONTEND_API_KEY = "CHANGE_ME_FRONTEND_KEY";
    // Backend base URL (same origin if served by Flask; otherwise set full URL)
    const BASE = "https://315917d3abc28f.lhr.life"; // e.g. "" or "http://127.0.0.1:5000"

    // ======== STATE PERSISTENCE (caching-like) ========
    // We cache the OTP session in localStorage so refresh/close+reopen resumes OTP screen
    const LS_KEY = "otpSession";

    function loadSession() {
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
      catch { return null; }
    }
    function saveSession(s) {
      localStorage.setItem(LS_KEY, JSON.stringify(s));
    }
    function clearSession() {
      localStorage.removeItem(LS_KEY);
    }

    // ======== UI HELPERS ========
    const el = (id) => document.getElementById(id);
    const formStart = el("formStart");
    const formOtp = el("formOtp");
    const tgidShow = el("tgidShow");
    const sessShow = el("sessShow");
    const expShow = el("expShow");
    const msg = el("msg");

    function showStart() {
      formStart.classList.remove("hidden");
      formOtp.classList.add("hidden");
    }
    function showOtp() {
      formStart.classList.add("hidden");
      formOtp.classList.remove("hidden");
    }
    function setMsg(text, type="") {
      msg.className = "center muted " + (type || "");
      msg.textContent = text;
    }
    function formatTs(ts) {
      try { return new Date(ts).toLocaleString(); } catch { return String(ts); }
    }

    // ======== RESUME ON LOAD ========
    (function init() {
      const s = loadSession();
      if (s && s.email && s.session_id && Date.now() < s.expires_at) {
        // Resume OTP waiting
        tgidShow.textContent = s.telegram_id;
        sessShow.textContent = s.session_id.slice(0,8) + "…";
        expShow.textContent = formatTs(s.expires_at);
        el("email").value = s.email || "";
        el("tgid").value = s.telegram_id || "";
        showOtp();
        setMsg("Waiting for OTP… you can enter it when ready.");
      } else {
        clearSession();
        showStart();
      }
    })();

    // ======== API WRAPPER ========
    async function api(path, data) {
      const res = await fetch(BASE + path, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": FRONTEND_API_KEY
        },
        body: JSON.stringify(data || {})
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || ("HTTP " + res.status));
      return json;
    }

    // ======== EVENTS ========
    el("resetBtn").addEventListener("click", () => {
      clearSession();
      (["email","password","tgid","otp"]).forEach(id => el(id).value = "");
      showStart();
      setMsg("Session cleared.");
    });

    formStart.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = el("email").value.trim();
      const password = el("password").value;
      const telegram_id = el("tgid").value.trim();
      if (!email || !password || !telegram_id) return setMsg("Please fill all fields.", "danger");

      setMsg("Sending OTP…");
      el("btnSend").disabled = true;
      try {
        const resp = await api("/api/send-otp", { email, password, telegram_id });
        // Save session to resume on refresh
        const s = {
          email,
          telegram_id,
          session_id: resp.session_id,
          expires_at: resp.expires_at
        };
        saveSession(s);
        tgidShow.textContent = telegram_id;
        sessShow.textContent = s.session_id.slice(0,8) + "…";
        expShow.textContent = formatTs(s.expires_at);
        showOtp();
        setMsg("OTP sent via Telegram. Please check your messages.");
      } catch (err) {
        setMsg(err.message || "Failed to send OTP.", "danger");
      } finally {
        el("btnSend").disabled = false;
      }
    });

    formOtp.addEventListener("submit", async (e) => {
      e.preventDefault();
      const otp = el("otp").value.trim();
      const s = loadSession();
      if (!s) return setMsg("No active session. Please start again.", "danger");
      if (!otp) return setMsg("Enter the OTP.", "danger");

      el("btnVerify").disabled = true;
      setMsg("Verifying OTP…");
      try {
        const resp = await api("/api/verify-otp", { email: s.email, session_id: s.session_id, otp });
        clearSession();
        showStart();
        setMsg("Login successful ✅", "success");
      } catch (err) {
        setMsg(err.message || "Verification failed.", "danger");
      } finally {
        el("btnVerify").disabled = false;
      }
    });

    el("btnResend").addEventListener("click", async () => {
      const s = loadSession();
      if (!s) return setMsg("No active session. Please start again.", "danger");
      setMsg("Resending OTP…");
      try {
        const resp = await api("/api/resend-otp", { email: s.email, session_id: s.session_id });
        // Update expiry if backend extended it
        if (resp.expires_at) {
          s.expires_at = resp.expires_at;
          saveSession(s);
          expShow.textContent = formatTs(s.expires_at);
        }
        setMsg("OTP re-sent via Telegram.");
      } catch (err) {
        setMsg(err.message || "Could not resend OTP.", "danger");
      }
    });
  </script>
</body>
</html>
